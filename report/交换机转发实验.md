# 交换机转发实验

## 实验内容

- 实现对数据结构mac_port_map的所有操作，以及数据包的转发和广播操作
  - iface_info_t *lookup_port(u8 mac[ETH_ALEN]);
  - void insert_mac_port(u8 mac[ETH_ALEN], iface_info_t *iface);
  - int sweep_aged_mac_port_entry();
  - void broadcast_packet(iface_info_t *iface, const char *packet, int len);
  - void handle_packet(iface_info_t *iface, char *packet, int len);
- 使用iperf和给定的拓扑进行实验，对比交换机转发与集线器广播的性能

## 实验步骤及结果

### `iface_info_t *lookup_port(u8 mac[ETH_ALEN])`实现

```c
iface_info_t *lookup_port(u8 mac[ETH_ALEN])
{
	// TODO: implement the lookup process here
	mac_port_entry_t *entry,*q;
	for (int i = 0; i < HASH_8BITS; i++) {
		list_for_each_entry_safe(entry, q, &mac_port_map.hash_table[i], list) {
			int cmp = memcmp((void*)entry->mac,(void*)mac,sizeof(u8)*ETH_ALEN); 
			if(cmp==0) return entry->iface;
		}
	}
	fprintf(stdout, "TODO: implement the lookup process here.\n");
	return NULL;
}
```

### `void insert_mac_port(u8 mac[ETH_ALEN], iface_info_t *iface)`实现

```c
void insert_mac_port(u8 mac[ETH_ALEN], iface_info_t *iface)
{
	// TODO: implement the insertion process here
    mac_port_entry_t *entry = malloc(sizeof(mac_port_entry_t));
    bzero(entry, sizeof(mac_port_entry_t));
    time_t now = time(NULL);
    entry->visited = now;
    memcpy(entry->mac, mac, sizeof(u8) * ETH_ALEN);
    entry->iface = iface;
    list_add_tail(&entry->list, &mac_port_map.hash_table[0]);//未发现哈希函数 全部放进第一个
	fprintf(stdout, "TODO: implement the insertion process here.\n");
}
```

### `int sweep_aged_mac_port_entry()`实现

```c
int sweep_aged_mac_port_entry()
{
	// TODO: implement the sweeping process here
	int n=0;
	mac_port_entry_t *entry, *q;
	time_t now = time(NULL);
	for (int i = 0; i < HASH_8BITS; i++) {
		list_for_each_entry_safe(entry,q, &mac_port_map.hash_table[i],list) {
			if((int)(now - entry->visited) >= MAC_PORT_TIMEOUT){
				n = entry->iface->index;
				list_delete_entry(&entry->list);
				free(entry);
				return n;
			}
		}
	}
	fprintf(stdout, "TODO: implement the sweeping process here.\n");
	return 0;
}
```

### `void broadcast_packet(iface_info_t *iface, const char *packet, int len)`实现

同实验1方法

### `void handle_packet(iface_info_t *iface, char *packet, int len)实现

```c
void handle_packet(iface_info_t *iface, char *packet, int len)
{
	// TODO: implement the packet forwarding process here
	fprintf(stdout, "TODO: implement the packet forwarding process here.\n");
	struct ether_header *eh = (struct ether_header *)packet;
	log(DEBUG, "the dst mac address is " ETHER_STRING ".\n", ETHER_FMT(eh->ether_dhost));
	iface_info_t *tx_iface = lookup_port(eh->ether_dhost);
	if (tx_iface) {
		iface_send_packet(tx_iface, packet, len);
	}
	else {
		broadcast_packet(iface, packet, len);
	}
	if (!lookup_port(eh->ether_shost)) {
		insert_mac_port(eh->ether_shost, iface);
	}
	free(packet);
}
```

### 运行步骤

make编译![image-20241111151427666](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111151427666.png)

执行py代码

![image-20241111151507774](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111151507774.png)

打开h1 h2 h3 s1节点终端，并在s1中执行交换器`./switch`

![image-20241111151604662](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111151604662.png)

此时用h1分别ping h2 h3 同时在抓包工具中监视

![image-20241111151755873](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111151755873.png)

![image-20241111151805911](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111151805911.png)

![image-20241111151819541](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111151819541.png)

测量带宽性能

![image-20241111152159696](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111152159696.png)

![image-20241111152329406](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111152329406.png)

和广播对比，有明显效率提升