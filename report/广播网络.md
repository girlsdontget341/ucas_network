# 广播网络实验实现

## 实验内容

- 实现节点广播的broadcast_packet函数

- 验证广播网络能够正常运行
  - 从一个端节点ping另一个端节点

- 验证广播网络的效率

  - 在three_nodes_bw.py进行iperf测量	

  - 两种场景：

    - H1: iperf client; H2, H3: servers （h1同时向h2和h3测量）

    - H1: iperf server; H2, H3: clients （ h2和h3 同时向h1测量）

- 自己动手构建环形拓扑，验证该拓扑下节点广播会产生数据包环路

## 实验流程及结果

### 编写`brocast_packet`函数

```c
void broadcast_packet(iface_info_t *iface, const char *packet, int len)
{
	iface_info_t *tx_iface = NULL;
	list_for_each_entry(tx_iface, &instance->iface_list, list) {
		if (tx_iface->index != iface->index)
			iface_send_packet(tx_iface, packet, len);
	}
	// TODO: broadcast packet 
	fprintf(stdout, "TODO: broadcast packet.\n");
}
```

只要转发接口不是自己就继续发

### 验证网络能否ping通

cd到当前目录下make，编译可执行hub文件

![image-20241111140140646](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111140140646.png)

执行`three_nodes_bw.py`脚本，构建基本的网络

![image-20241111140407960](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111140407960.png)

pingall	![image-20241111140545750](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111140545750.png)

 发现h1，h2都ping不通h3，分别观察mac地址发现缺失，于是分别设置相同mac地址

![image-20241111140715708](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111140715708.png)

![image-20241111140736636](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111140736636.png)

再次尝试能否ping通

![image-20241111140829379](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111140829379.png)

![image-20241111140847557](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111140847557.png)

发现都可以ping通

### 验证传播效率

xterm h1 h2 h3 b1打开节点终端

#### H1: iperf client; H2, H3: servers （h1同时向h2和h3测量）

![image-20241111141056279](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111141056279.png)

#### H1: iperf server; H2, H3: clients （ h2和h3 同时向h1测量）

![image-20241111141402300](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111141402300.png)

### 自己动手构建环形拓扑，验证该拓扑下节点广播会产生数据包环路

首先根据环路改写py代码

```python
class BroadcastTopo(Topo):
    def build(self):
        h1 = self.addHost('h1')
        h2 = self.addHost('h2')
        b1 = self.addHost('b1')
        b2 = self.addHost('b2')
        b3 = self.addHost('b3')

        self.addLink(h1, b1, bw=20)
        self.addLink(h2, b2, bw=10)
        self.addLink(b1, b2, bw=10)
        self.addLink(b1, b3, bw=10)
        self.addLink(b2, b3, bw=10)

if __name__ == '__main__':
    check_scripts()

    topo = BroadcastTopo()
    net = Mininet(topo = topo, link = TCLink, controller = None) 

    h1, h2, b1, b2, b3 = net.get('h1', 'h2', 'b1', 'b2', 'b3')
    h1.cmd('ifconfig h1-eth0 10.0.0.1/8')
    h2.cmd('ifconfig h2-eth0 10.0.0.2/8')
    clearIP(b1)
    clearIP(b2)
    clearIP(b3)

    for h in [ h1, h2, b3, b1, b2]:
        h.cmd('./scripts/disable_offloading.sh')
        h.cmd('./scripts/disable_ipv6.sh')

    net.start()
    CLI(net)
    net.stop()
```

重新执行py代码

![image-20241111142559216](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111142559216.png)

打开五个节点终端并启动集线器

![image-20241111142801950](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111142801950.png)

![image-20241111142841225](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111142841225.png)

在h1ping h2

![image-20241111143303559](C:\Users\15pro\AppData\Roaming\Typora\typora-user-images\image-20241111143303559.png)

可以观察到b1，b2，b3不断输出`brocast packet`,同时抓包循环抓到数据，说明已经形成环路.